
- RECOMENDATION & REASONS
- CITY 1: PUNE
  1. AVG RENT PER CUSTOMER IS LESS.
  2. HIGHEST TOTAL REVENUE. - 1258290
  3. AVG SALE PER CUSTOMER IS ALSO HIGH.

- CITY 2 : DELHI
  1. HIGHEST ESTIMATED COFEE CUNSUMERS WHICH IS 7.75 ILLIONS.
  2. AVERAGE RENT PER CUSTOMER IS LESS.
  3. DELHI RANKS 5TH IN REVENUE GENERATION AMONG THE TOP CITIES.
  
- CITY 3 : JAIPUR
  1. AVERAGE RENT PER CUSTOMER IS VERY LESS. WHICH IS - 156
  2. JAIPUR RANKS 4TH IN REVENUE GENERATION AMONG THE TOP CITIES. 
  3. JAIPUR RANKS 4TH IN AVERAGE SALE PER CUSTOMER AMONG THE TOP CITIES.


CREATE DATABASE MONDAY_COFEE;

    create table city (
    CITY_ID int not null primary key,
    CITY_NAME VARCHAR (20) NOT NULL,
    POPULATION BIGINT NOT NULL,
    ESTIMATED_RANK FLOAT NOT NULL,
    CITY_RANK INT 
    );


    CREATE TABLE CUSTOMERS (
    CUSTOMER_ID INT PRIMARY KEY,
    CUSTOMER_NAME VARCHAR (20) NOT NULL,
    CITY_ID INT NOT NULL
    );
 
 
    CREATE TABLE PRODUCTS	 (
    PRODUCT_ID INT NOT NULL PRIMARY KEY,
    PRODUCT_NAME VARCHAR (40) NOT NULL,
    PRICE INT NOT NULL
    );


    create table SALES (
    SALES_ID int not null primary key,
    SALE_DATE DATE NOT NULL,
    PRODUCT_ID INT NOT NULL,
    CUSTOMER_ID INT NOT NULL,
    TOTAL BIGINT NOT NULL,
    RATING INT NOT NULL 
    );


-- QUESTION - 1 
-- HOW MANY PEOPLE IN EACH CITY ARE ESTIMATED TO CONSUME COFFEE, GIVEN THAT 25% OF THE POPULATION DOES ? 


    SELECT CITY_NAME, ROUND(POPULATION/1000000,1) AS TOTAL_POPULATION_IN_MILLIONS, ROUND(POPULATION*.25/1000000,1) AS 
    25_PERCENT_OF_TOTAL_POPULATION_IN_MILLIONS FROM CITY;


-- QUESTION - 2
-- TOTAL REVENUE GENERATED FROM COFFEE SALES ACROSS ALL CITIES IN THE LAST QUARTER OF 2023. 

    SELECT CITY_NAME, SUM(total) as TOTAL_REVENUE FROM SALES S JOIN customers c on c.CUSTOMER_ID = s.CUSTOMER_ID JOIN city ci on 
    ci.CITY_ID = c.CITY_ID  where year(sale_date) = 2023 and quarter(sale_date) = 4 GROUP BY (city_name) order by SUM(total) desc 
    limit 5;


-- QUESTION - 3
-- HOW MANY UNITS OF EACH COFFEE PRODUCT HAVE BEEN SOLD.

    SELECT P.PRODUCT_NAME  , COUNT(S.PRODUCT_ID) FROM PRODUCTS P JOIN SALES S ON P.PRODUCT_ID = S.PRODUCT_ID GROUP BY 
    PRODUCT_NAME ORDER BY COUNT(S.PRODUCT_ID) DESC;   


-- QUESTION - 4
-- AVERAGE SALES AMOUNT PER CUSTOMER IN EACH CITY.

    SELECT C.CITY_NAME , SUM(S.TOTAL) / COUNT(DISTINCT CU.CUSTOMER_ID) AS AVERAGE_SALES_AMOUNT_PER_CUSTOMER FROM CITY C JOIN 
    CUSTOMERS CU ON C.CITY_ID = CU.CITY_ID JOIN sales S ON S.CUSTOMER_ID = CU.CUSTOMER_ID GROUP BY C.CITY_NAME ORDER BY 
    SUM(S.TOTAL) / COUNT(DISTINCT CU.CUSTOMER_ID) DESC;


-- QUESTION - 5
-- LIST OF CITIES ALONG WITH THEIR POPULATIONS 	AND ESTIMATED COFFEE CONSUMERS.

    SELECT C.CITY_NAME, C.POPULATION*25/100000000 AS TOTAL_CUSTOMERS_IN_M , COUNT(DISTINCT CU.CUSTOMER_ID) AS CUSTOMER_AT_MOMENT 
    FROM CITY C JOIN CUSTOMERS CU ON C.CITY_ID = CU.CITY_ID GROUP BY C.CITY_NAME , C.POPULATION*25/100000000 ORDER BY 
    COUNT(CU.CUSTOMER_ID) DESC; 


-- QUESTION - 6
-- TOP 3 SELLING PRODUCTS in EACH CITY BASED ON SALES VOLUME.

    select CITY_NAME, PRODUCT_NAME, SALES_COUNT from 
    (select ci.CITY_NAME, p.PRODUCT_NAME, count(s.SALES_ID), dense_rank() over(partition by ci.CITY_NAME order by count(s.SALES_ID) 
    desc) as SALES_COUNT from products p join sales s on p.PRODUCT_ID = s.PRODUCT_ID join customers cu on 
    s.CUSTOMER_ID = cu.CUSTOMER_ID join city ci on cu.CITY_ID = ci.CITY_ID group by PRODUCT_NAME, CITY_NAME order by 
    ci.CITY_NAME, count(s.SALES_ID) desc) as t1 where SALES_COUNT<=3;    
 
 
-- QUESTION - 7
-- HOW MANY UNIQUE CUSTOMERS ARE THERE IN EACH CITY WHO HAVE PURCHASED COFFEE PRODUCTS.   

    SELECT CI.CITY_NAME , COUNT(DISTINCT CU.CUSTOMER_ID) UNIQUE_CUSTOMER FROM PRODUCTS P JOIN SALES S ON P.PRODUCT_ID = 
    S.PRODUCT_ID JOIN CUSTOMERS CU ON S.CUSTOMER_ID = CU.CUSTOMER_ID JOIN CITY CI ON CU.CITY_ID = CI.CITY_ID  WHERE P.PRODUCT_ID 
    <= 14 GROUP BY CI.CITY_NAME; 


-- QUESTION - 8
-- FIND EACH CITY AND THEIR AVERAGE SALE PER CUSTOMER AND AVERAGE RENT PER CUSTOMER. 
-- I AM CHANGING THE COLUMN NAME UNDER TABLE CITY. 

    ALTER TABLE CITY CHANGE COLUMN ESTIMATED_RANK ESTIMATED_RENT BIGINT;

    SELECT C.CITY_NAME ,C.ESTIMATED_RENT, COUNT(DISTINCT CU.CUSTOMER_ID) AS CUSTOMERS_IN_EACH_CITY, SUM(S.TOTAL) / 
    COUNT(DISTINCT CU.CUSTOMER_ID) AS AVERAGE_SALES_AMOUNT_PER_CUSTOMER, C.ESTIMATED_RENT/COUNT(DISTINCT CU.CUSTOMER_ID) as
    AVG_RENT_PER_CUSTOMER FROM CITY C JOIN CUSTOMERS CU ON C.CITY_ID = CU.CITY_ID JOIN sales S ON S.CUSTOMER_ID = CU.CUSTOMER_ID 
    GROUP BY C.CITY_NAME ,C.ESTIMATED_RENT ORDER BY AVG_RENT_PER_CUSTOMER DESC;


-- Q.9 - MONTHLY SALES GROWTH
-- SALES GROWTH RATE: CALCULATE THE PERCENTAGE GROWTH (OR DECLINE) IN SALES OVER DIFFERENT TIME PERIOD (MONTHLY.)

    WITH MONTHLY_SALES AS
    (SELECT CITY_NAME, MONTH(SALE_DATE) AS MONTH,YEAR(SALE_DATE) AS YEAR, SUM(TOTAL) AS TOTAL_SALE
    FROM SALES S JOIN CUSTOMERS
    CU ON S.CUSTOMER_ID = CU.CUSTOMER_ID JOIN CITY C ON C.CITY_ID = CU.CITY_ID
    GROUP BY MONTH(SALE_DATE),YEAR(SALE_DATE),CITY_NAME ORDER BY CITY_NAME ,YEAR(SALE_DATE),MONTH(SALE_DATE)),
    GROWTH_RATIO AS
    (
    SELECT CITY_NAME, MONTH,YEAR,TOTAL_SALE AS CURRENT_MONTH_SALE, LAG(TOTAL_SALE,1) OVER (PARTITION BY CITY_NAME) AS 
    PREVIOUS_MONTH_SALE FROM MONTHLY_SALES
    )
    SELECT CITY_NAME, MONTH,YEAR,CURRENT_MONTH_SALE, PREVIOUS_MONTH_SALE , (CURRENT_MONTH_SALE -  PREVIOUS_MONTH_SALE)/
    PREVIOUS_MONTH_SALE*100 AS SALES_RATIO FROM GROWTH_RATIO WHERE PREVIOUS_MONTH_SALE IS NOT NULL;


-- Q.10 - MARKET POTENTIAL ANALYSIS
-- IDENTIFY TOP 3 CITY BASED ON HIGHEST SALES, RETURN CITY NAME , TOTAL SALE , TOTAL RENT , TOTAL CUSTOMERS , ESTIMATED COFEE CONSUMERS. 

    SELECT CI.CITY_NAME , SUM(S.TOTAL) , CI.ESTIMATED_RENT , COUNT(DISTINCT CU.CUSTOMER_ID) AS TOTAL_CUSTOMERS,
    CI.POPULATION*.25/1000000 AS COFFEE_CONSUMERS_IN_MILLIONS , SUM(S.TOTAL) / COUNT(DISTINCT CU.CUSTOMER_ID) AS 
    AVERAGE_SALE_PER_CUSTOMER , CI.ESTIMATED_RENT / COUNT(DISTINCT CU.CUSTOMER_ID) AS AVG_RENT_PER_CUST
    FROM SALES S 
    JOIN CUSTOMERS CU ON S.CUSTOMER_ID = CU.CUSTOMER_ID JOIN CITY CI ON CU.CITY_ID = CI.CITY_ID GROUP BY CI.CITY_NAME,
    CI.ESTIMATED_RENT,COFFEE_CONSUMERS_IN_MILLIONS ORDER BY SUM(S.TOTAL) DESC; 


 
